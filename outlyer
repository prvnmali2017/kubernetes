
###
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: outlyer-agent
  namespace: kube-system
  labels:
    app: outlyer-agent
    tier: monitoring
    version: v2
spec:
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: outlyer-agent
    spec:
      # allow the running on master nodes
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      serviceAccountName: outlyer-agent
      containers:
      - env:
        - name: AGENT_KEY
          valueFrom:
            secretKeyRef:
              name: outlyer-agent-key
              key: accountKey
        - name: K8S_CLUSTER
          valueFrom:
               configMapKeyRef:
                 name: outlyer-config
                 key: k8s.cluster
        # The following information comes from the Downward API:
        # Docs: https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        # Add additional agent environment variables here if needed
        # Docs: https://docs2.outlyer.com/agent/docker/#extra-options
        # Also add -java to the image tag to pull down the agent with Java for monitoring JMX
        - name: TINI_SUBREAPER
          value: set
        image: outlyer/agent2:1.4.6
        imagePullPolicy: Always
        name: outlyer-agent
        resources:
          limits:
            cpu: 400m
            memory: 400Mi
          requests:
            cpu: 200m
            memory: 200Mi
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /var/run/docker.sock
          name: docker-socket
        - mountPath: /host/proc
          name: proc
          readOnly: true
        - mountPath: /host/sys/fs/cgroup
          name: sysfscgroup
          readOnly: true
        livenessProbe:
          httpGet:
            path: /healthz
            port: 2014
            httpHeaders:
              - name: X-Custom-Header
                value: Liveness
          initialDelaySeconds: 3
          periodSeconds: 10
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      hostIPC: true
      hostPID: true
      volumes:
      - hostPath:
          path: /var/run/docker.sock
        name: docker-socket
      - hostPath:
          path: /sys/fs/cgroup
        name: sysfscgroup
      - hostPath:
          path: /proc
        name: proc
